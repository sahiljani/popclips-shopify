name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          command_timeout: 30m
          script: |
            # Ignore .bashrc errors
            set +e
            source ~/.bashrc 2>/dev/null || true
            set -e
            
            cd /home/janisahil-popclips/htdocs/popclips.janisahil.com || exit 1
            
            echo "ğŸš€ Starting deployment..."
            
            # Enable maintenance mode
            php artisan down --refresh=15 --retry=60 2>/dev/null || echo "âš ï¸ Maintenance mode skipped"
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Code updated from GitHub"
            
            # Remove vendor to avoid autoloader conflicts
            rm -rf vendor
            echo "âœ… Cleaned vendor directory"
            
            # Install fresh production dependencies
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            echo "âœ… Composer dependencies installed"
            
            # Build assets if npm available
            if command -v npm &> /dev/null; then
              npm ci
              npm run build
              echo "âœ… Assets built"
            else
              echo "âš ï¸ npm not found, assets not rebuilt"
            fi
            
            # Run migrations
            php artisan migrate --force || {
              echo "âŒ Migration failed"
              php artisan up 2>/dev/null || true
              exit 1
            }
            echo "âœ… Migrations completed"
            
            # Optimize application
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            echo "âœ… Application optimized"
            
            # Restart queue workers
            php artisan queue:restart 2>/dev/null || echo "â„¹ï¸ No queue workers"
            
            # Set permissions
            chmod -R 775 storage bootstrap/cache 2>/dev/null || true
            
            # Disable maintenance mode
            php artisan up 2>/dev/null || echo "âœ… Application is live"
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸš€ Application is now live!"

      - name: Verify Deployment
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cd /home/janisahil-popclips/htdocs/popclips.janisahil.com
            
            echo "ğŸ” Verifying deployment..."
            
            # Check application health
            if php artisan about --only=environment 2>/dev/null; then
              echo "âœ… Application is healthy!"
            else
              echo "âš ï¸ Could not verify application health"
            fi

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ âœ… DEPLOYMENT SUCCESSFUL âœ… ğŸ‰"
            echo "ğŸš€ Application deployed and live at your domain!"
          else
            echo "âŒ âŒ DEPLOYMENT FAILED âŒ âŒ"
            echo "âš ï¸ Check logs above for error details"
            exit 1
          fi
