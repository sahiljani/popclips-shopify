name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "‚úÖ SSH Connection successful!"
            whoami
            pwd
            ls -la /home/janisahil-popclips/htdocs/ | head -20

      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          command_timeout: 30m
          script: |
            cd /home/janisahil-popclips/htdocs/popclips.janisahil.com || exit 1
            
            echo "üöÄ Starting deployment..."
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ Code updated"
            
            # Install dependencies
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            echo "‚úÖ Dependencies installed"
            
            # Build assets
            npm ci && npm run build
            echo "‚úÖ Assets built"
            
            # Run migrations
            php artisan migrate --force
            echo "‚úÖ Migrations done"
            
            # Clear and cache
            php artisan optimize
            echo "‚úÖ Optimized"
            
            # Set permissions
            chmod -R 775 storage bootstrap/cache
            
            echo "‚úÖ Deployment completed!"

      - name: Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          else
            echo "‚ùå DEPLOYMENT FAILED!"
          fi
