name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy and run deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cd /home/janisahil-popclips/htdocs/popclips.janisahil.com
            
            echo "ğŸš€ Starting deployment via GitHub Actions..."
            
            # Verify we're in the right directory
            if [ ! -f "artisan" ]; then
              echo "âŒ Error: artisan file not found. Wrong directory?"
              exit 1
            fi
            
            # Pull latest changes from GitHub
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Code updated from GitHub"
            
            # Enable maintenance mode
            php artisan down --refresh=15 --retry=60 || echo "âš ï¸ Maintenance mode failed"
            
            # Install Composer dependencies (production)
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            echo "âœ… Composer dependencies installed"
            
            # Install NPM dependencies and build assets
            if command -v npm &> /dev/null; then
              npm ci
              npm run build
              echo "âœ… Frontend assets built"
            else
              echo "âš ï¸ npm not found, skipping frontend build"
            fi
            
            # Run database migrations
            php artisan migrate --force || {
              echo "âŒ Error: Migration failed"
              php artisan up
              exit 1
            }
            echo "âœ… Migrations completed"
            
            # Optimize application
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            echo "âœ… Application optimized"
            
            # Restart queue workers
            php artisan queue:restart 2>/dev/null || echo "â„¹ï¸ No queue workers to restart"
            
            # Set correct permissions
            chmod -R 775 storage bootstrap/cache 2>/dev/null
            
            # Disable maintenance mode
            php artisan up
            echo "âœ… Maintenance mode disabled"
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸš€ Application is now live!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cd /home/janisahil-popclips/htdocs/popclips.janisahil.com
            
            echo "ğŸ” Verifying deployment..."
            
            # Check if application is healthy
            if php artisan about &> /dev/null; then
              echo "âœ… Application is healthy"
              php artisan about --only=environment
            else
              echo "âŒ Application health check failed"
              exit 1
            fi
            
            echo "âœ… Deployment verification completed!"

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… âœ… âœ… DEPLOYMENT SUCCESSFUL âœ… âœ… âœ…"
            echo "ğŸš€ Application deployed and verified successfully!"
          else
            echo "âŒ âŒ âŒ DEPLOYMENT FAILED âŒ âŒ âŒ"
            echo "âš ï¸ Check the logs above for details"
          fi
